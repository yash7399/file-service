private void copyFile(ChannelSftp sftp,
                      String connectionCode,
                      DiskShare share,
                      String smbShareName,
                      String fileName,
                      String sftpFilePath,
                      String destinationPath,
                      int time,
                      String department,
                      Map<String, List<String>> missingFiles,
                      Map<String, List<String>> transferedFiles)
        throws SftpException, IOException {

    String[] folders = destinationPath.split("/");
    String currentPath = "";

    for (String folder : folders) {
        currentPath = currentPath.isEmpty() ? folder : currentPath + "/" + folder;
        try {
            share.mkdir(currentPath);
        } catch (SMBApiException e) {
            if (e.getStatus() != NtStatus.STATUS_OBJECT_NAME_COLLISION) {
                log.info("Error in making folder " + e);
            }
        }
    }

    long fileSize = sftp.stat(sftpFilePath).getSize();
    int bufferSize = getBufferSize(fileSize);   // keep your existing logic

    try {

        log.info("Starting direct transfer: " + fileName);

        try (InputStream sftpInput = sftp.get(sftpFilePath);
             com.hierynomus.smbj.share.File smbFile =
                     share.openFile(destinationPath + "\\" + fileName,
                             EnumSet.of(AccessMask.FILE_WRITE_DATA),
                             EnumSet.of(FileAttributes.FILE_ATTRIBUTE_NORMAL),
                             SMB2ShareAccess.ALL,
                             SMB2CreateDisposition.FILE_OVERWRITE_IF,
                             null);
             OutputStream smbOutput = smbFile.getOutputStream()) {

            byte[] buffer = new byte[bufferSize];
            int bytesRead;

            while ((bytesRead = sftpInput.read(buffer)) != -1) {
                smbOutput.write(buffer, 0, bytesRead);
            }

            smbOutput.flush();

            log.info("Direct SFTP â†’ SMB transfer completed: " + fileName);
        }

    } catch (SftpException e) {

        if (e.id == ChannelSftp.SSH_FX_PERMISSION_DENIED) {
            log.error("Error in transferring file: " + e.getMessage());
            throw e;
        } else {
            log.error(e);
            sftp = SFTPConnection.connect(connectionCode);
            Session smb = NASConnection.connect();
            share = (DiskShare) smb.connectShare(smbShareName);
        }

    } catch (IOException e) {

        String msg = e.getMessage() != null ? e.getMessage().toLowerCase() : "";

        if (msg.contains("access is denied") ||
            msg.contains("permission denied") ||
            msg.contains("being used")) {

            log.error("Error in transferring file: " + e.getMessage());
            throw e;

        } else if (msg.contains("disk full") ||
                   msg.contains("no space left") ||
                   msg.contains("not enough space")) {

            log.error("Disk size full", e);
            emails.connectionIssue();

        } else {
            log.error(e);
            sftp = SFTPConnection.connect(connectionCode);
            Session smb = NASConnection.connect();
            share = (DiskShare) smb.connectShare(smbShareName);
        }

    } catch (Exception e) {
        log.error(e);
        emails.connectionIssue();
    }
}